<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test de fatigue</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .page {
      display: none;
      background: white;
      padding: 40px 20px;
      max-width: 700px;
      margin: 50px auto;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      animation: fadeIn 0.4s ease;
    }

    .page.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- HEADER LOGOS --- */
    .header-logos {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .header-logos img { height: 60px; }

    /* --- PAGE ACCUEIL --- */
    #home { text-align: center; }

    .title { font-size: 36px; margin-bottom: 20px; }

    .center-image {
      width: 80%;
      max-width: 400px;
      margin: 0 auto 30px auto;
      display: block;
    }

    .start-button {
      font-size: 24px;
      padding: 15px 40px;
      background-color: #d32f2f;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    .start-button:hover { background-color: #b71c1c; }

    /* --- PAGE QUESTIONS --- */
    #questionText { font-size: 26px; margin-bottom: 15px; }

    #questionImage {
      display: none;
      max-width: 100%;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .progress-container { margin-bottom: 20px; }

    #questionCounter { font-size: 14px; color: #555; }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 5px;
    }

    #progressFill {
      height: 100%;
      width: 0%;
      background: #1976d2;
      transition: width 0.4s ease;
    }

    .answer-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    textarea {
      flex: 1;
      height: 70px;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: none;
    }

    .arrow-button {
      width: 50px;
      height: 50px;
      font-size: 24px;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }

    .arrow-button:hover:not(:disabled) {
      background-color: #0d47a1;
      transform: scale(1.1);
    }

    .arrow-button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
      transform: none;
    }

    /* --- PAGE FIN --- */
    .finish-button {
      padding: 15px 40px;
      font-size: 20px;
      background-color: #b71c1c;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    .finish-button:hover { background-color: #1b5e20; }

    /* --- LOADING OVERLAY --- */
    .loading-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(245,245,245,0.8);
      z-index: 9999;
    }

    .loading-overlay.active { display: flex; }

    .spinner {
      width: 64px;
      height: 64px;
      border: 8px solid #cfd8dc;
      border-top-color: #1976d2;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

  </style>
</head>

<body>

<!-- LOADING OVERLAY -->
<div id="loading" class="loading-overlay" aria-hidden="true">
  <div class="spinner" aria-label="Chargement"></div>
</div>

<!-- PAGE ACCUEIL -->
<div id="home" class="page active">
  <div class="header-logos">
    <img src="{{ url_for('static', filename='logo-crossing.png') }}">
    <img src="{{ url_for('static', filename='logo-UT.png') }}">
  </div>

  <h1 class="title">Test de fatigue</h1>
  <img src="{{ url_for('static', filename='logo-leia.png') }}" class="center-image">

  <p>
    Ce test permet d’évaluer votre état de vigilance.
    Le temps de réponse et les frappes clavier sont analysés.
  </p>

  <button class="start-button" onclick="startTest()">Commencer le test</button>
</div>

<!-- PAGE QUESTIONS -->
<div id="questionPage" class="page">
  <div class="header-logos">
    <img src="{{ url_for('static', filename='logo-leia.png') }}">
    <img src="{{ url_for('static', filename='logo-UT.png') }}">
  </div>

  <div class="progress-container">
    <span id="questionCounter"></span>
    <div class="progress-bar">
      <div id="progressFill"></div>
    </div>
  </div>

  <!-- IMAGE facultative -->
  <img id="questionImage" src="" alt="">

  <h2 id="questionText"></h2>

  <div class="answer-row">
    <textarea id="input" placeholder="Écrivez votre réponse ici..."></textarea>
    <button class="arrow-button" onclick="nextQuestion()" disabled>➜</button>
  </div>
</div>

<!-- PAGE FIN -->
<div id="end" class="page">
  <h2>Test terminé</h2>
  <p>Merci pour votre participation.</p>
  <button class="finish-button" onclick="finishTest()">Finir le test</button>
</div>

<script>
  // Questions are served by the backend.
  let totalQuestions = 0;
  let currentQuestionData = null;

  let currentQuestion = 0;
  let questionStartTime = 0;
  let testStartTime = 0;
  let keystrokes = [];
  const results = [];

  const input = document.getElementById("input");
  const questionText = document.getElementById("questionText");
  const questionImage = document.getElementById("questionImage");
  const progressFill = document.getElementById("progressFill");
  const questionCounter = document.getElementById("questionCounter");
  const arrowButton = document.querySelector(".arrow-button");
  const loadingOverlay = document.getElementById("loading");

  function setLoading(isLoading) {
    if (isLoading) {
      loadingOverlay.classList.add("active");
      loadingOverlay.setAttribute("aria-hidden", "false");
    } else {
      loadingOverlay.classList.remove("active");
      loadingOverlay.setAttribute("aria-hidden", "true");
    }
  }

  function showPage(id) {
    document.querySelectorAll(".page").forEach(p => {
      p.classList.remove("active");
      p.style.display = "none";
    });
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.add("active");
    el.style.display = "block";
  }

  // Force initial page state on first load.
  document.addEventListener("DOMContentLoaded", () => {
    showPage("home");
  });

  async function startTest() {
    currentQuestion = 0;
    testStartTime = Date.now();
    results.length = 0;
    showPage("questionPage");

    try {
      setLoading(true);
      const startResp = await fetch("/api/start_test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ n: 4, difficulty: "easy" })
      });
      const startData = await startResp.json();
      totalQuestions = startData.total || 0;
      await loadQuestion(0);
    } catch (err) {
      console.error("Erreur start_test:", err);
      alert("Erreur lors de la génération du quiz");
      showPage("home");
    } finally {
      setLoading(false);
    }
  }

  async function loadQuestion(index) {
    const qResp = await fetch(`/api/question/${index}`);
    const qData = await qResp.json();
    if (qData.done) {
      showPage("end");
      return;
    }
    currentQuestionData = qData;
    showQuestionFromData(qData);
  }

  function showQuestionFromData(qData) {
    input.value = "";
    keystrokes = [];

    questionText.textContent = qData.question || "";

    if (qData.image) {
      questionImage.src = qData.image;
      questionImage.style.display = "block";
    } else {
      questionImage.style.display = "none";
    }

    questionStartTime = Date.now();
    const total = qData.total || totalQuestions || 1;
    const idx = (qData.index ?? currentQuestion) + 1;
    questionCounter.textContent = `Question ${idx} / ${total}`;
    progressFill.style.width = `${(idx / total) * 100}%`;

    arrowButton.disabled = true;
    showPage("questionPage");
  }

  input.addEventListener("input", () => {
    arrowButton.disabled = input.value.trim() === "";
  });

  input.addEventListener("keydown", (event) => {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      if (!arrowButton.disabled) nextQuestion();
    }

    keystrokes.push({
      touche: event.key,
      temps: Date.now() - questionStartTime
    });
  });

  async function nextQuestion() {
    const timeSpent = Date.now() - questionStartTime;
    results.push({
      question: (currentQuestionData && currentQuestionData.question) ? currentQuestionData.question : "",
      answer: input.value,
      timeSpent: timeSpent,
      keystrokes: keystrokes
    });

    currentQuestion++;
    try {
      setLoading(true);
      await loadQuestion(currentQuestion);
    } finally {
      setLoading(false);
    }
  }

  function finishTest() {
    const totalTestTime = Date.now() - testStartTime;
    const payload = { totalTestTime: totalTestTime, results: results };

    fetch("/save_results", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
      alert("Résultats envoyés au serveur avec succès !");
      console.log("Serveur :", data);
    })
    .catch(err => {
      console.error("Erreur d'envoi :", err);
      alert("Erreur lors de l'envoi des résultats");
    });
  }

</script>
</body>
</html>
